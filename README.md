# USB设备指纹识别系统 - 使用指南

## 📋 系统概述

本系统基于USB通信流量的时间序列特征，为USB设备（特别是U盘）生成唯一的"指纹"，用于设备认证和身份识别。

### ✨ 核心功能

- ✅ **图形界面**: 美观直观的GUI操作界面（推荐使用）
- ✅ **设备注册**: 为已知设备创建指纹并存入数据库
- ✅ **智能认证**: 支持一对一和一对多两种认证模式
- ✅ **自动采集**: 引导用户完成USB流量数据采集过程
- ✅ **数据库管理**: 查看、删除已注册设备
- ✅ **配置管理**: 图形化配置系统参数

---

## 🚀 快速开始

### 环境要求

- **操作系统**: Windows 10/11
- **Python**: 3.7+
- **依赖软件**: Wireshark (包含TShark)
- **Python库**: pyshark, numpy, ttkbootstrap

### 安装依赖

```bash
pip install pyshark numpy ttkbootstrap
```

### 启动程序

**推荐方式 - GUI界面**:
```bash
python Main_GUI.py
```

**传统方式 - 命令行**:
```bash
python Main.py
```

### 项目结构

```
usb/
├── Main_GUI.py                # 🎯 GUI主程序（推荐使用）
├── Main.py                    # CLI主程序（备用）
├── config.json                # 系统配置文件
├── usb_fingerprint_db.json    # 指纹数据库
├── 技术原理与数学模型.md      # 技术文档（答辩参考）
├── AGENTS.md                  # 开发者指南
├── utils/                     # 📦 核心功能模块
│   ├── FeatureExtractor.py    # 特征提取引擎（优化提取）
│   ├── Authenticate.py        # 设备认证模块（改进算法）
│   ├── Register.py            # 设备注册模块
│   ├── AutoCatch.py           # 数据采集模块
│   └── gui_utils.py           # GUI辅助工具模块
└── devices/                   # 📁 数据文件夹
    ├── enroll/                # 注册样本（自动清理）
    └── auth/                  # 验证样本
```

---

## 🖥️ GUI界面使用教程（推荐）

### 启动GUI

```bash
python Main_GUI.py
```

### 界面概览

GUI界面包含四个主要功能标签页：

#### 📝 设备注册
两种注册方式可选：

1. **从文件注册**
   - 适用于已有 `.pcapng` 文件的情况
   - 选择文件夹路径：`devices/enroll/`
   - 输入设备名称（如：`SanDisk_32G`）
   - 点击"开始注册"

2. **采集+注册**
   - 适用于新U盘首次录入
   - 输入U盘盘符（如：`E`）
   - 输入设备名称
   - 设置采集次数（建议3-5次）
   - 点击"开始采集"
   - **按对话框提示操作**：系统会弹出确认框，提示插拔U盘
   - 自动完成注册
   - ✨ **注册后自动清空** `enroll` 文件夹，避免不同设备样本混淆

#### 🔍 设备认证

**认证模式选择**：
- 🔍 **一对多认证**（默认，推荐）
  - 自动匹配数据库中最相似的设备
  - 用于识别未知U盘
  - 无需指定设备ID
  
- 🎯 **一对一认证**
  - 验证是否为指定设备
  - 需要输入目标设备ID
  - 用于设备真伪验证

**数据来源选择**：
- **从文件认证**: 选择包含验证数据的文件夹
- **实时采集认证**: 输入U盘盘符，按提示插拔U盘

**认证参数**：
- 相似度阈值（0-100，默认70）
- 阈值越高，认证越严格

**认证结果显示**：
- ✅ **绿色 - 认证通过**: 
  - 一对多：显示"找到匹配设备：XXX"
  - 一对一：显示"确认为设备：XXX"
- ❌ **红色 - 认证失败**: 
  - 显示最接近设备和相似度
  - 给出判定原因

#### 💾 数据库管理
- 查看所有已注册设备列表
- 显示设备ID、注册时间、样本数量
- 刷新列表
- 删除选中设备

#### ⚙ 系统配置
可配置项：
- **TShark路径**: Wireshark TShark程序位置
- **USB接口**: USBPcap捕获接口（如：USBPcap3）
- **数据根目录**: 样本文件存储位置
- **数据库文件**: 指纹数据库路径

配置修改后点击"保存配置"即可生效。

### 系统日志窗口

底部日志窗口（18行）实时显示：
- 操作进度提示
- 特征提取详情
- 错误和警告信息
- 采集引导提示

### 重要提示

⚠️ **采集过程中的对话框交互**：
- 系统会弹出确认对话框，提示插拔U盘
- 点击"确定"继续，点击"取消"中止操作
- 注意按对话框提示操作，不要提前插拔U盘

✅ **注册后自动清理**：
- 每次注册成功后，`devices/enroll/` 文件夹会自动清空
- 避免不同设备样本互相覆盖
- 下次注册时从干净状态开始

---

## 📖 CLI命令行使用（备用）

如果需要使用命令行界面：

```bash
python Main.py
```

系统会显示三种模式供选择：

```
【模式选择】
1. [设备注册] - 从现有采集文件生成指纹
2. [采集+注册] - 完整的新设备录入流程
3. [设备认证] - 验证未知设备身份
```

### 模式1: 设备注册

1. 将 `.pcapng` 文件放入 `devices/enroll/`
2. 选择模式 **1**
3. 输入设备名称
4. 系统自动提取特征并注册

### 模式2: 采集+注册

1. 选择模式 **2**
2. 输入U盘盘符、设备名称、采集次数
3. 按提示插拔U盘完成采集
4. 选择是否立即注册

### 模式3: 设备认证

**方式A**: 从已有文件认证
- 将验证文件放入 `devices/auth/`
- 选择方式 **A**

**方式B**: 实时采集并认证
- 选择方式 **B**
- 按提示插拔U盘

---

## 🔐 认证原理

### 特征提取

系统提取两类时序特征：

1. **枚举特征** (权重30%)
   - USB设备枚举阶段的时间统计
   - 反映设备与主机的协商速度
   - 典型值：0.001s - 5.0s（优化后范围）

2. **传输特征** (权重70%)
   - 不同Endpoint的包间时间间隔
   - 反映设备控制器的时序特性
   - 典型值：0.0001s - 0.01s

### 相似度计算（改进算法）

使用**多维度评分机制**：

```
1. 绝对差异：|mean1 - mean2|
2. 相对差异：abs_diff / mean_avg
3. 归一化差异：abs_diff / std_avg

相对分数 = 100 - (相对差异 × 200)
归一化分数 = 100 - (归一化差异 × 20)

相似度 = min(相对分数, 归一化分数)

变异系数检查：CV > 1.5 时降低20%可信度
```

**改进点**：
- 引入相对差异判断，防止大标准差导致误判
- 提高惩罚系数（10→20），使评分更严格
- 添加变异系数检查，评估数据质量

### 综合相似度

```
S_overall = 0.3 × S_enum + 0.7 × S_transfer_avg
```

### 认证判定

- **≥70%**: 认证通过，设备合法 ✅
- **<70%**: 认证失败，可能是未授权设备 ❌

阈值可在GUI的"系统配置"中调整。

---

## 📊 数据库格式

`usb_fingerprint_db.json` 存储设备指纹：

```json
{
  "SanDisk_32G": {
    "fingerprint": {
      "enumeration": {
        "mean": 0.1235,
        "std": 0.0843,
        "count": 3
      },
      "transfers": {
        "1": {
          "mean": 0.000673,
          "std": 0.001183,
          "count": 2320
        },
        "130": {
          "mean": 0.000890,
          "std": 0.001474,
          "count": 1860
        }
      }
    },
    "reg_time": "2026-01-13 15:30:45",
    "samples_count": 3,
    "source_files": [
      "capture_1.pcapng",
      "capture_2.pcapng",
      "capture_3.pcapng"
    ]
  }
}
```

---

## 🛠️ 故障排除

### 常见问题

#### Q1: 找不到TShark

**错误**: `找不到 Tshark`

**解决方案**:
- 安装 [Wireshark](https://www.wireshark.org/download.html)
- 在GUI的"系统配置"中设置正确路径
- 或修改 `config.json` 中的 `tshark_path`

#### Q2: GUI程序无法启动

**错误**: `ModuleNotFoundError: No module named 'ttkbootstrap'`

**解决方案**:
```bash
pip install ttkbootstrap
```

#### Q3: 采集时程序无响应

**原因**: 已在最新版本中修复

**确认版本**: 确保使用最新的 `Main_GUI.py` 和 `utils/AutoCatch.py`

#### Q4: 不同U盘认证相似度都很高

**原因**: 已在最新版本中修复（改进相似度算法）

**解决方案**:
- 使用最新版 `utils/Authenticate.py`
- 重新注册设备以获得更好的区分度
- 适当提高阈值（如75-80%）

#### Q5: 枚举特征为null

**原因**: 已优化，放宽了枚举时间范围

**当前范围**: 0.001s - 5.0s（原来是0.01-2.0s）

**解决方案**:
- 使用最新版 `utils/FeatureExtractor.py`
- 查看日志中的调试信息
- 如果是"未找到Control包"，检查采集数据质量

#### Q6: 认证相似度太低

**现象**: 相同U盘认证相似度<70%

**解决方案**:
- 增加注册样本数量（5-10个）
- 在相同USB端口采集
- 在GUI中降低阈值（如60-65%）
- 避免系统高负载时采集

---

## 🔧 高级配置

### 配置文件 (config.json)

GUI自动管理配置，也可手动编辑：

```json
{
  "tshark_path": "C:\\Program Files\\Wireshark\\tshark.exe",
  "interface": "USBPcap3",
  "base_folder": "devices",
  "db_file": "usb_fingerprint_db.json",
  "auth_threshold": 70.0,
  "theme": "darkly",
  "window_geometry": "1100x750"
}
```

### 调整采集参数

编辑 `utils/AutoCatch.py`：

```python
target_size_mb=50  # 采集的数据量（MB）
```

### 调整相似度算法参数

编辑 `utils/Authenticate.py`：

```python
relative_score = max(0, 100 - relative_diff_ratio * 200)  # 相对差异惩罚
normalized_score = max(0, 100 - normalized_diff * 20)     # 归一化惩罚
cv_threshold = 1.5  # 变异系数阈值
```

---

## 🎯 应用场景

### 企业安全
- **未授权设备检测**: 识别员工私自使用的U盘
- **设备白名单**: 只允许已注册的U盘
- **数据泄露防护**: 阻止未知U盘接入

### 取证分析
- **设备溯源**: 确认特定U盘是否连接过系统
- **时间线分析**: 结合时间戳建立事件序列

### 研究用途
- **USB设备特性研究**: 分析不同厂商/型号的时序差异
- **物理层指纹**: 探索硬件级别的设备识别

---

## 📝 开发指南

### 模块架构

```
Main_GUI.py          - GUI界面和事件处理
  ├── utils/gui_utils.py      - GUI辅助工具（日志重定向、线程管理）
  ├── utils/AutoCatch.py      - USB流量采集（支持GUI回调）
  ├── utils/Register.py       - 指纹注册逻辑
  ├── utils/Authenticate.py   - 指纹认证逻辑（改进算法）
  └── utils/FeatureExtractor.py - 特征提取引擎（优化提取范围）
       └── pyshark             - pcapng解析
```

### 技术特性

**GUI实现**:
- 框架: tkinter + ttkbootstrap
- 多线程: 避免界面冻结
- 对话框交互: 替代阻塞式input()
- 日志重定向: 捕获所有print输出
- 配置持久化: JSON格式存储

**算法改进**:
- 多维度相似度计算
- 变异系数质量检查
- 自适应阈值机制

### 扩展开发

#### 添加新特征

在 `utils/FeatureExtractor.py` 中扩展：

```python
def extract_new_feature(cap):
    # 自定义特征提取逻辑
    pass
```

#### 自定义相似度算法

在 `utils/Authenticate.py` 中修改：

```python
def calculate_similarity(feature1, feature2):
    # 使用其他算法：马氏距离、余弦相似度等
    pass
```

---

## 📚 文档参考

- **技术原理与数学模型.md**: 详细的算法原理和数学推导（答辩必读）
- **AGENTS.md**: 开发者指南和代码规范
- **改进总结_USB指纹识别系统优化.md**: 详细技术文档
- 源码注释: 每个函数都有详细docstring

---

## ✅ 功能清单

- [x] GUI界面
- [x] 设备注册（文件/采集）
- [x] 智能认证（一对一/一对多）
- [x] 数据库管理
- [x] 配置管理
- [x] 实时日志显示（18行窗口）
- [x] 多线程处理
- [x] 对话框交互（无阻塞）
- [x] 自动清理enroll文件夹
- [x] 改进相似度算法
- [x] 优化枚举特征提取
- [ ] 实时监控模式
- [ ] 机器学习分类器
- [ ] 批量操作

---

## 🎓 使用建议

### 最佳实践

1. **注册设备**:
   - 采集3-5个样本以提高准确性
   - 在相同USB端口进行采集
   - 避免系统高负载时采集

2. **认证设备**:
   - 首次使用可适当降低阈值（如65%）
   - 观察日志中的相似度详情
   - 使用一对多模式识别未知设备
   - 使用一对一模式验证指定设备

3. **数据管理**:
   - 定期备份 `usb_fingerprint_db.json`
   - 清理不再使用的设备记录
   - 注意 `devices/auth/` 文件会被覆盖
   - `devices/enroll/` 注册后自动清空

### 安全提示

⚠️ 本系统基于时序特征，存在一定误差：
- 不应作为唯一的安全验证手段
- 建议结合其他认证方式（如硬件ID）
- 定期更新指纹数据库

---

## 📄 版本信息

**当前版本**: 3.6 (稳定版)  
**更新日期**: 2026-01-14  

**最新更新**:
- 📦 项目模块化重组（所有核心模块移至 `utils/` 目录）
- 📁 优化项目结构，提高代码组织清晰度
- ✨ 添加一对一/一对多认证模式选择
- 🔧 改进相似度算法（多维度评分）
- 🔧 优化枚举特征提取（放宽时间范围）
- 🔧 修复GUI交互阻塞问题（对话框替代input）
- 🔧 修复实时认证死机问题（后台线程执行）
- ✨ 自动清空enroll文件夹（避免样本混淆）
- 📝 增大系统日志窗口（10行→18行）
- 🎨 优化认证结果显示（区分不同模式）

**作者**: USB Fingerprint Team  
**用途**: 学习研究

---

## 🙏 致谢

感谢以下开源项目：
- [Wireshark](https://www.wireshark.org/) - 网络协议分析
- [pyshark](https://github.com/KimiNewt/pyshark) - Python包解析
- [ttkbootstrap](https://github.com/israel-dryer/ttkbootstrap) - tkinter美化

---

**快速开始**: `python Main_GUI.py` 🚀  
**技术文档**: 查看 `技术原理与数学模型.md`  
**项目状态**: ✅ 稳定运行，测试通过
